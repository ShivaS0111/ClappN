<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hosted Payment Page</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        #app { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h2 { color: #333; }
        #content { margin: 20px 0; }
        .payment-details { background: #f9f9f9; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .detail-row { display: flex; justify-content: space-between; margin: 10px 0; }
        .detail-label { font-weight: bold; color: #555; }
        .detail-value { color: #333; }
        button { background: #4CAF50; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background: #45a049; }
        button:disabled { background: #cccccc; cursor: not-allowed; }
        .error { color: #d32f2f; padding: 10px; background: #ffebee; border-radius: 5px; margin: 10px 0; }
        .success { color: #388e3c; padding: 10px; background: #e8f5e9; border-radius: 5px; margin: 10px 0; }
        .loading { text-align: center; padding: 20px; }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #4CAF50; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
<div id="app">
    <h2>ðŸ’³ Hosted Payment Page</h2>
    <div id="content">Loadingâ€¦</div>
</div>
<script>
    // URL: /pay/index.html#token=BASE64_JSON
    function parseToken(){
      const h = location.hash || '';
      const m = h.match(/token=(.*)/);
      if(!m) return null;
      try{ return JSON.parse(atob(decodeURIComponent(m[1]))); }catch(e){ console.error('Token parse error:', e); return null; }
    }

    function showError(msg) {
      document.getElementById('content').innerHTML = '<div class="error"><strong>Error:</strong> ' + msg + '</div>';
    }

    function showSuccess(msg) {
      document.getElementById('content').innerHTML = '<div class="success"><strong>Success:</strong> ' + msg + '</div>';
    }

    async function initiatePayment(token) {
      const payBtn = document.getElementById('pay');
      payBtn.disabled = true;
      payBtn.innerText = 'Processing...';

      try {
        const resp = await fetch('/api/payments/initiate', {
          method: 'POST',
          headers: {'content-type': 'application/json'},
          body: JSON.stringify({
            orderId: token.orderId,
            amount: token.amount,
            currency: token.currency,
            gateway: token.gateway
          })
        });

        if (!resp.ok) {
          const error = await resp.text();
          showError('Payment initiation failed: ' + error);
          payBtn.disabled = false;
          payBtn.innerText = 'Proceed to Pay';
          return;
        }

        const body = await resp.json();
        console.log('Payment response:', body);

        if (!body.redirectUrl) {
          showError('No redirect URL provided by payment gateway');
          payBtn.disabled = false;
          payBtn.innerText = 'Proceed to Pay';
          return;
        }

        // For real integration:
        // - For Stripe: redirect to Checkout URL
        // - For Razorpay: open Razorpay checkout
        if (token.gateway === 'STRIPE') {
          window.location.href = body.redirectUrl;
        } else if (token.gateway === 'RAZORPAY') {
          // Open Razorpay checkout
          showSuccess('Redirecting to Razorpay...');
          setTimeout(() => { window.location.href = body.redirectUrl; }, 1500);
        } else {
          window.location.href = body.redirectUrl;
        }
      } catch (err) {
        console.error('Payment error:', err);
        showError('Payment initiation error: ' + err.message);
        payBtn.disabled = false;
        payBtn.innerText = 'Proceed to Pay';
      }
    }

    const token = parseToken();
    const content = document.getElementById('content');

    if (!token) {
      showError('Invalid or missing payment token. Please initiate payment from the order page.');
    } else if (!token.orderId || !token.amount || !token.currency || !token.gateway) {
      showError('Incomplete payment token. Missing: ' +
        (token.orderId ? '' : 'orderId ') +
        (token.amount ? '' : 'amount ') +
        (token.currency ? '' : 'currency ') +
        (token.gateway ? '' : 'gateway'));
    } else {
      content.innerHTML = '<div class="payment-details">' +
                          '<div class="detail-row"><span class="detail-label">Order ID:</span><span class="detail-value">' + token.orderId + '</span></div>' +
                          '<div class="detail-row"><span class="detail-label">Amount:</span><span class="detail-value">' + (token.amount/100).toFixed(2) + ' ' + token.currency + '</span></div>' +
                          '<div class="detail-row"><span class="detail-label">Gateway:</span><span class="detail-value">' + token.gateway + '</span></div>' +
                          '</div>' +
                          '<button id="pay">Proceed to Pay with ' + token.gateway + '</button>';
      document.getElementById('pay').addEventListener('click', () => { initiatePayment(token); });
    }
</script>
</body>
</html>
